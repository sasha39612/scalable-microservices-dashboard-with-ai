services:
  redis:
    image: redis:7-alpine
    container_name: redis
    # Remove public port exposure - only accessible within Docker network
    # ports:
    #   - "6379:6379"  # SECURITY: Commented out to prevent public exposure
    expose:
      - "6379"  # Expose only to internal Docker network
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
    command: sh -c 'redis-server --requirepass "$$REDIS_PASSWORD" --bind 0.0.0.0 --protected-mode yes --maxmemory 256mb --maxmemory-policy allkeys-lru --save 900 1 --save 300 10 --save 60 10000 --appendonly no'
    healthcheck:
      test: ["CMD", "sh", "-c", "redis-cli -a $$REDIS_PASSWORD ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - redis-data:/data
    networks:
      - backend

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile.dev
    container_name: frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/app:/app/app
      - ./frontend/components:/app/components
      - ./frontend/contexts:/app/contexts
      - ./frontend/hooks:/app/hooks
      - ./frontend/styles:/app/styles
      - ./frontend/tests:/app/tests
      - ./frontend/utils:/app/utils
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/next.config.mjs:/app/next.config.mjs
      - ./frontend/postcss.config.mjs:/app/postcss.config.mjs
      - ./frontend/tailwind.config.ts:/app/tailwind.config.ts
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://api-gateway:4000/graphql
    working_dir: /app
    command: pnpm dev
    depends_on:
      - api-gateway
    networks:
      - backend

  api-gateway:
    build:
      context: .
      dockerfile: backend/api-gateway/Dockerfile.dev
    container_name: api-gateway
    ports:
      - "4000:4000"
    volumes:
      - ./backend/api-gateway/src:/app/backend/api-gateway/src
      - ./backend/common/src:/app/backend/common/src
      - ./backend/api-gateway/tests:/app/backend/api-gateway/tests
      - ./backend/api-gateway/tsconfig.json:/app/backend/api-gateway/tsconfig.json
    environment:
      - NODE_ENV=development
      - PORT=4000
      - DATABASE_URL=postgresql://dashboard_user:VO3k7I38xXKV9sNzasMuMocNH@138.199.175.38:5432/microservices_dashboard
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET:-dev-jwt-access-secret-change-in-production}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET:-dev-jwt-refresh-secret-change-in-production}
      - WORKER_SERVICE_URL=http://worker-service:4001
      - WORKER_SERVICE_API_KEY=${WORKER_SERVICE_API_KEY:-worker-secret-key-change-in-production}
      - AI_SERVICE_URL=http://ai-service:5000
      - AI_SERVICE_API_KEY=${AI_SERVICE_API_KEY:-ai-secret-key-change-in-production}
    working_dir: /app/backend/api-gateway
    command: pnpm start:dev
    depends_on:
      ai-service:
        condition: service_healthy
      worker-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - backend

  worker-service:
    build:
      context: .
      dockerfile: backend/worker-service/Dockerfile.dev
    container_name: worker-service
    ports:
      - "4001:4001"
    volumes:
      - ./backend/worker-service/src:/app/backend/worker-service/src
      - ./backend/common/src:/app/backend/common/src
    environment:
      - NODE_ENV=development
      - PORT=4001
      - WORKER_SERVICE_API_KEY=${WORKER_SERVICE_API_KEY:-worker-secret-key-change-in-production}
    working_dir: /app/backend/worker-service
    command: ts-node-dev --respawn --transpile-only src/main.ts
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - backend

  ai-service:
    build:
      context: .
      dockerfile: backend/ai-service/Dockerfile.dev
    container_name: ai-service
    ports:
      - "5000:5000"
    volumes:
      - ./backend/ai-service/src:/app/backend/ai-service/src
      - ./backend/common/src:/app/backend/common/src
    environment:
      - NODE_ENV=development
      - PORT=5000
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AI_SERVICE_API_KEY=${AI_SERVICE_API_KEY:-ai-secret-key-change-in-production}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-changeme}@redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-changeme}
    working_dir: /app/backend/ai-service
    command: ts-node-dev --respawn --transpile-only src/main.ts
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - backend

volumes:
  redis-data:

networks:
  backend:
    driver: bridge
